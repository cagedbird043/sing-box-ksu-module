name: Build and Release Module

on:
  workflow_dispatch:
  push:
    branches:
      - master
    paths-ignore:
      - "README.md"
      - ".gitignore"
  pull_request:
    branches:
      - master

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch Specific Sing-box Binary (Stable Only)
        run: |
          # 1. 抓取稳定版版本号
          SB_VER=$(curl -s https://api.github.com/repos/cagedbird043/sing-box-auto-build-ci/releases | \
            jq -r 'map(select(.tag_name | contains("alpha") | not) | select(.tag_name | contains("dev") | not)) | .[0].tag_name')

          if [ -z "$SB_VER" ] || [ "$SB_VER" == "null" ]; then
            echo "Error: Could not find a stable release tag."
            exit 1
          fi
          echo "Detected Stable Version: $SB_VER"
          echo "SB_VER=$SB_VER" >> $GITHUB_ENV

          # 2. 获取下载地址并解压到已存在的 bin 目录
          DOWNLOAD_URL=$(curl -s https://api.github.com/repos/cagedbird043/sing-box-auto-build-ci/releases/tags/$SB_VER | \
            jq -r '.assets[] | select(.name | contains("android-arm64")) | .browser_download_url')

          echo "Downloading from: $DOWNLOAD_URL"
          curl -L -o sing-box-android.tar.gz "$DOWNLOAD_URL"
          # 注意：bin 目录由于存放了 sbc，已经存在，直接解压
          tar -xzf sing-box-android.tar.gz -C bin/
          mv bin/sing-box* bin/sing-box || true
          chmod +x bin/sing-box

      - name: Fetch Config Template
        run: |
          # 1. 抓取 mobile 分支的配置模板
          mkdir -p etc
          curl -fL -o etc/config.template.json https://raw.githubusercontent.com/cagedbird043/sing-box-config-templates/mobile/config.template.json

          # 2. 抓取 main 分支的 .env 示例文件
          # 物理放置在根目录，因为它最终要出现在 workspace 的根目录
          curl -fL -o .env.example https://raw.githubusercontent.com/cagedbird043/sing-box-config-templates/main/.env.example

      - name: Prepare Module Versioning
        run: |
          # 获取运行修订号
          MOD_REV="${{ github.run_number }}"
          DISPLAY_VER="${SB_VER}-r${MOD_REV}"
          V_CODE=$(date +%Y%m%d)$MOD_REV

          echo "DISPLAY_VER=$DISPLAY_VER" >> $GITHUB_ENV
          echo "V_CODE=$V_CODE" >> $GITHUB_ENV

          # 动态修改元数据
          sed -i "s/^version=.*/version=$DISPLAY_VER/" module.prop
          sed -i "s/^versionCode=.*/versionCode=$V_CODE/" module.prop
          sed -i "s/\"version\": \".*\"/\"version\": \"$DISPLAY_VER\"/" update.json
          sed -i "s/\"versionCode\": .*,/\"versionCode\": $V_CODE,/" update.json
          sed -i "s|\"zipUrl\": \".*\"|\"zipUrl\": \"https://github.com/${{ github.repository }}/releases/latest/download/sing-box-ksu-module.zip\"|" update.json

      - name: Extract Changelog
        run: |
          # 提取 CHANGELOG.md 中对应版本的内容
          # 逻辑：匹配 ## DISPLAY_VER 到下一个 ## 之间的内容
          # 如果没找到，则使用最后一条 git commit message
          VERSION_ESCAPED=$(echo "${{ env.DISPLAY_VER }}" | sed 's/\./\\./g')
          sed -n "/## $VERSION_ESCAPED/,/## /p" CHANGELOG.md | sed '$d' > release_body.txt

          if [ ! -s release_body.txt ]; then
            git log -1 --pretty=%B > release_body.txt
          fi

      - name: Create Module Package
        run: |
          # 没有任何 mv，直接打包，实现“所见即所得”
          ZIP_NAME="sing-box-ksu-module.zip"
          zip -r $ZIP_NAME bin etc system customize.sh service.sh module.prop update.json LICENSE CHANGELOG.md README.md .env.example
          echo "ZIP_PATH=$ZIP_NAME" >> $GITHUB_ENV

      - name: Release Module
        if: github.event_name != 'pull_request'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.DISPLAY_VER }}
          name: Sing-box for KSU [${{ env.DISPLAY_VER }}]
          body_path: release_body.txt # 使用提取到的日志
          files: ${{ env.ZIP_PATH }}
          generate_release_notes: false # 禁用自动生成的记录，使用我们的 release_body.txt
          overwrite_files: true
          token: ${{ secrets.GITHUB_TOKEN }}
