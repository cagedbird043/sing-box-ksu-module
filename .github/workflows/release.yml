name: Build and Release Module

on:
  workflow_dispatch:
  push:
    branches: ["main"]
    paths-ignore:
      - "README.md"
      - ".gitignore"
      - "update.json" # [防线1] 忽略 update.json 的变更触发

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch Material
        run: |
          # 1. 抓取稳定二进制
          SB_VER=$(curl -s https://api.github.com/repos/cagedbird043/sing-box-auto-build-ci/releases | \
            jq -r 'map(select(.tag_name | contains("alpha") | not) | select(.tag_name | contains("dev") | not)) | .[0].tag_name')

          echo "SB_VER=$SB_VER" >> $GITHUB_ENV

          DOWNLOAD_URL=$(curl -s https://api.github.com/repos/cagedbird043/sing-box-auto-build-ci/releases/tags/$SB_VER | \
            jq -r '.assets[] | select(.name | contains("android-arm64")) | .browser_download_url')

          curl -L -o sing-box-android.tar.gz "$DOWNLOAD_URL"
          tar -xzf sing-box-android.tar.gz -C bin/

          # 如果解压出来不叫 sing-box，才执行改名
          if [ ! -f "bin/sing-box" ]; then
              mv bin/sing-box* bin/sing-box
          fi
          chmod +x bin/sing-box

          # 2. 抓取模板
          curl -fL -o etc/config.template.json https://raw.githubusercontent.com/cagedbird043/sing-box-config-templates/mobile/config.template.json
          curl -fL -o .env.example https://raw.githubusercontent.com/cagedbird043/sing-box-config-templates/main/.env.example

      - name: Prepare Module Versioning
        run: |
          # 动态计算修订号与版本
          MOD_REV="${{ github.run_number }}"
          DISPLAY_VER="${SB_VER}-r${MOD_REV}"
          V_CODE=$(date +%Y%m%d)$MOD_REV

          echo "DISPLAY_VER=$DISPLAY_VER" >> $GITHUB_ENV

          # 替换 module.prop 中的占位符 (源码里要是 ${VAR} 格式)
          sed -i "s/\${DISPLAY_VER}/$DISPLAY_VER/" module.prop
          sed -i "s/\${V_CODE}/$V_CODE/" module.prop

          # 提取 Changelog
          VERSION_ESCAPED=$(echo "$DISPLAY_VER" | sed 's/\./\\./g')
          sed -n "/## $VERSION_ESCAPED/,/## /p" CHANGELOG.md | sed '$d' > release_body.txt

          if [ ! -s release_body.txt ]; then
            echo "Build from main branch commit: ${{ github.sha }}" > release_body.txt
          fi

      - name: Create Package
        run: |
          # update.json 不打包，只在 Repo 层面维护
          zip -r sing-box-ksu-module.zip bin etc system customize.sh service.sh module.prop LICENSE CHANGELOG.md README.md .env.example

      - name: Release Module
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.DISPLAY_VER }}
          name: Sing-box for KSU [${{ env.DISPLAY_VER }}]
          body_path: release_body.txt
          files: sing-box-ksu-module.zip
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Backfill Update Info
        if: github.event_name != 'pull_request'
        run: |
          # 更新 update.json 并回写到仓库
          jq ".version = \"${{ env.DISPLAY_VER }}\" | .versionCode = $(date +%Y%m%d)${{ github.run_number }} | .zipUrl = \"https://github.com/${{ github.repository }}/releases/latest/download/sing-box-ksu-module.zip\"" update.json > update.tmp
          mv update.tmp update.json

          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add update.json
          # [防线2] 加上 [skip ci] 确保万无一失
          git commit -m "chore: auto-update metadata for ${{ env.DISPLAY_VER }} [skip ci]" || exit 0
          git push origin main
