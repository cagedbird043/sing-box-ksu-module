name: Build Core Module
on:
  workflow_dispatch:
  push:
    branches: ["main"]
    paths:
      [
        "bin/**",
        "service.sh",
        "customize.sh",
        "uninstall.sh",
        "module.prop",
        ".github/workflows/release.yml",
        "CHANGELOG.md",
      ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch Latest Core
        env:
          # æ˜¾å¼å¼•ç”¨ Tokenï¼Œç¡®ä¿æœ‰æƒé™è°ƒç”¨ API
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ” Fetching latest sing-box version..."

          # 1. æŠ“å–ç‰ˆæœ¬å· (å¸¦ Token)
          # æ³¨æ„ï¼šè¿™é‡ŒåŠ äº† -H Authorization
          SB_VER=$(curl -s -H "Authorization: Bearer $GH_TOKEN" https://api.github.com/repos/Mice-Tailor-Infra/sing-box-auto-build-ci/releases | jq -r 'map(select(.tag_name | contains("alpha") | not)) | .[0].tag_name')

          # å¢åŠ ç©ºå€¼æ£€æµ‹ï¼Œé˜²æ­¢æŠ¥é”™ä¹Ÿä¸çŸ¥æƒ…
          if [ -z "$SB_VER" ] || [ "$SB_VER" == "null" ]; then
            echo "âŒ Error: Failed to fetch version tag. API limit exceeded or repo not found."
            exit 1
          fi

          echo "âœ… Detected version: $SB_VER"

          # 2. è·å–ä¸‹è½½åœ°å€ (å¸¦ Token)
          DOWNLOAD_URL=$(curl -s -H "Authorization: Bearer $GH_TOKEN" https://api.github.com/repos/Mice-Tailor-Infra/sing-box-auto-build-ci/releases/tags/$SB_VER | jq -r '.assets[] | select(.name | contains("android-arm64")) | .browser_download_url')

          if [ -z "$DOWNLOAD_URL" ] || [ "$DOWNLOAD_URL" == "null" ]; then
             echo "âŒ Error: Could not find android-arm64 asset."
             exit 1
          fi

          echo "â¬‡ï¸ Downloading from: $DOWNLOAD_URL"
          curl -L -o sb.tar.gz "$DOWNLOAD_URL"

          # 3. é²æ£’è§£å‹é€»è¾‘
          mkdir -p temp_sb
          tar -xzf sb.tar.gz -C temp_sb/

          # åœ°æ¯¯å¼æœç´¢
          TARGET_BIN=$(find temp_sb -type f -name "sing-box" | head -n 1)
          if [ -z "$TARGET_BIN" ]; then
              TARGET_BIN=$(find temp_sb -type f -name "sing-box*" ! -name "*.tar.gz" | head -n 1)
          fi

          if [ -n "$TARGET_BIN" ]; then
              mv "$TARGET_BIN" bin/sing-box
              chmod +x bin/sing-box
              echo "âœ… Sing-box core successfully installed."
          else
              echo "âŒ Error: Binary not found in archive."
              exit 1
          fi

          rm -rf temp_sb sb.tar.gz

      - name: Prepare Module Metadata
        run: |
          BASE_VER=$(grep -m 1 "^## " CHANGELOG.md | sed 's/## //')
          # æå–æœ€æ–°ç‰ˆæœ¬çš„ Release Notes (è·³è¿‡ç¬¬ä¸€ä¸ª ## æ ‡é¢˜è¡ŒåŠéšåçš„ç©ºè¡Œ)
          awk '/^## /{count++; next} count==1{print}' CHANGELOG.md | sed '/./,$!d' > release_notes.md
          # ç‰ˆæœ¬å·åªä¿ç•™åŸºç¡€ç‰ˆï¼Œä¸å¸¦ cfg ç¢å±‘
          V_CODE=$(date +%Y%m%d%H)
          sed -i "s/\${DISPLAY_VER}/$BASE_VER/" module.prop
          sed -i "s/\${V_CODE}/$V_CODE/" module.prop
          # Add timestamp to module.prop updateJson
          sed -i "s|update.json|update.json?t=$V_CODE|" module.prop
          echo "VERSION=$BASE_VER" >> $GITHUB_ENV

      - name: Pack and Release
        run: |
          ZIP_NAME="sing-box-ksu-module-${{ env.VERSION }}.zip"
          # åªæ‰“åŒ…æ ¸å¿ƒæ–‡ä»¶ï¼Œæ’é™¤æ–‡æœ¬æ–‡æ¡£å’Œç¤ºä¾‹é…ç½®ï¼ˆäº‘ç«¯ç®¡ç†ï¼‰
          zip -ry "$ZIP_NAME" bin/ system/ customize.sh uninstall.sh service.sh module.prop README.md
          echo "ZIP_PATH=$ZIP_NAME" >> $GITHUB_ENV

      - name: Publish to GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION }}
          files: ${{ env.ZIP_PATH }}
          body_path: release_notes.md
          generate_release_notes: false

      - name: Update OTA Metadata
        run: |
          # 1. æ›´æ–° update.json
          jq ".version = \"${{ env.VERSION }}\" | .versionCode = $(date +%Y%m%d%H) | .zipUrl = \"https://ghfast.top/https://github.com/${{ github.repository }}/releases/latest/download/${{ env.ZIP_PATH }}\" | .changelog = \"https://miceworld.top/sing-box-ksu-module/CHANGELOG.md?t=$(date +%Y%m%d%H)\"" update.json > tmp.json && mv tmp.json update.json

          # 2. é…ç½® Git èº«ä»½
          git config --global user.name "github-actions[bot]"
          git config --global user.email "actions@github.com"

          # 3. åªæäº¤ update.jsonï¼Œä¸è¦æäº¤ module.prop (ä¿æŒå ä½ç¬¦)
          git add update.json

          # 4. åªåœ¨ update.json çœŸæ­£å˜åŒ–æ—¶æ‰æäº¤ï¼Œé˜²æ­¢åœ¨åªæ›´æ”¹ README æˆ– CI é€»è¾‘æ—¶äº§ç”Ÿç©ºçš„ chore commit
          # ä½¿ç”¨ -- update.json é™åˆ¶ diff èŒƒå›´ï¼Œå¹¶æ¸…ç†ä¸­é—´äº§ç‰©
          rm -f release_notes.md
          git diff-index --quiet HEAD update.json || (git commit -m "chore: release ${{ env.VERSION }} [skip ci]" && git push)
