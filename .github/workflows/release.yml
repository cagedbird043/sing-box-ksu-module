name: Build Core Module
on:
  workflow_dispatch:
  push:
    branches: ["main"]
    paths:
      [
        "bin/**",
        "service.sh",
        "customize.sh",
        "module.prop",
        "release.yml",
        "CHANGELOG.md",
      ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch Latest Core
        run: |
          # 1. æŠ“å–ç‰ˆæœ¬å·
          SB_VER=$(curl -s https://api.github.com/repos/cagedbird043/sing-box-auto-build-ci/releases | jq -r 'map(select(.tag_name | contains("alpha") | not)) | .[0].tag_name')

          # 2. è·å– android-arm64 ä¸‹è½½åœ°å€
          DOWNLOAD_URL=$(curl -s https://api.github.com/repos/cagedbird043/sing-box-auto-build-ci/releases/tags/$SB_VER | jq -r '.assets[] | select(.name | contains("android-arm64")) | .browser_download_url')

          echo "Downloading from: $DOWNLOAD_URL"
          curl -L -o sb.tar.gz "$DOWNLOAD_URL"

          # 3. é²æ£’è§£å‹é€»è¾‘ï¼šåŸåœ°è§£å‹ï¼Œç„¶åå…¨é‡æœç´¢
          mkdir -p temp_sb
          tar -xzf sb.tar.gz -C temp_sb

          # å¯»æ‰¾åä¸º sing-box çš„æ–‡ä»¶å¹¶ç§»åŠ¨åˆ°ç›®æ ‡ä½ç½®
          # è¿™é‡Œçš„ find ä¼šæ— è§†å®ƒæ˜¯ç›´æ¥åœ¨æ ¹ç›®å½•è¿˜æ˜¯åœ¨ bin å­ç›®å½•
          find temp_sb -type f -name "sing-box" -exec mv {} bin/sing-box \;

          # å…œåº•ï¼šå¦‚æœæ–‡ä»¶åå¸¦åç¼€ï¼ˆå¦‚ sing-box-android-arm64ï¼‰ï¼Œä¹Ÿç»™å®ƒé‡å‘½åè¿‡æ¥
          if [ ! -f bin/sing-box ]; then
            find temp_sb -type f -name "sing-box*" ! -name "*.tar.gz" -exec mv {} bin/sing-box \;
          fi

          chmod +x bin/sing-box
          rm -rf temp_sb sb.tar.gz

      - name: Fetch Default Config (Mobile)
        run: |
          echo "ğŸ“¥ Grabbing latest mobile config from EdgeOne..."
          # å¼ºåˆ¶å¸¦æ—¶é—´æˆ³ç©¿é€ç¼“å­˜ï¼Œç¡®ä¿æ‰“è¿›åŒ…é‡Œçš„æ˜¯æœ€æ–°ç‰ˆ
          curl -fL -o config.template.json "https://miceworld.top/sing-box-config-templates/mobile/config.template.json?t=$(date +%s)"

          # ç®€å•æ ¡éªŒä¸€ä¸‹ï¼Œé˜²æ­¢ä¸‹æ­ªäº†
          if ! grep -q "inbounds" config.template.json; then
            echo "âŒ Error: Downloaded config is invalid!"
            exit 1
          fi

      - name: Prepare Module Metadata
        run: |
          BASE_VER=$(grep -m 1 "^## " CHANGELOG.md | sed 's/## //')
          # ç‰ˆæœ¬å·åªä¿ç•™åŸºç¡€ç‰ˆï¼Œä¸å¸¦ cfg ç¢å±‘
          V_CODE=$(date +%Y%m%d%H)
          sed -i "s/\${DISPLAY_VER}/$BASE_VER/" module.prop
          sed -i "s/\${V_CODE}/$V_CODE/" module.prop
          echo "VERSION=$BASE_VER" >> $GITHUB_ENV

      - name: Pack and Release
        run: |
          ZIP_NAME="sing-box-ksu-module-${{ env.VERSION }}.zip"
          zip -ry "$ZIP_NAME" bin system customize.sh service.sh module.prop LICENSE CHANGELOG.md README.md .env.example config.template.json
          echo "ZIP_PATH=$ZIP_NAME" >> $GITHUB_ENV

      - name: Publish to GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION }}
          files: ${{ env.ZIP_PATH }}
          generate_release_notes: true

      - name: Update OTA Metadata
        run: |
          # 1. æ›´æ–° update.json
          jq ".version = \"${{ env.VERSION }}\" | .versionCode = $(date +%Y%m%d%H) | .zipUrl = \"https://github.com/${{ github.repository }}/releases/latest/download/${{ env.ZIP_PATH }}\"" update.json > tmp.json && mv tmp.json update.json

          # 2. é…ç½® Git èº«ä»½
          git config --global user.name "github-actions[bot]"
          git config --global user.email "actions@github.com"

          # 3. æŠŠ module.prop ä¹ŸåŠ è¿›å»ï¼
          git add update.json module.prop

          # 4. æ™ºèƒ½æäº¤ï¼šåªæœ‰æ£€æµ‹åˆ°å˜åŠ¨æ‰ commitï¼Œé˜²æ­¢æŠ¥é”™
          git diff-index --quiet HEAD || (git commit -m "chore: release ${{ env.VERSION }} [skip ci]" && git push)
