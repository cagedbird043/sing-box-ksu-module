#!/system/bin/sh
# Mice System Tools - Sing-box Controller (Professional Edition)

WORKSPACE="/data/adb/sing-box-workspace"
BIN="$WORKSPACE/bin/sing-box"
ENV_FILE="$WORKSPACE/.env"
TEMPLATE="$WORKSPACE/config.template.json"
CONFFILE="$WORKSPACE/etc/config.json"
SERVICE_PATH="/data/adb/modules/sing-box-ksu-module/service.sh"
LOG_FILE="$WORKSPACE/var/log/sing-box.log"
TEMPLATE_URL="https://miceworld.top/sing-box-config-templates/mobile/config.template.json"
ENV_EXAMPLE="$WORKSPACE/.env.example"
ENV_EXAMPLE_URL="https://miceworld.top/sing-box-config-templates/mobile/.env.example"

case "$1" in
    start)
        if pgrep -f "$BIN" > /dev/null; then
            echo "Sing-box å·²ç»åœ¨è¿è¡Œä¸­ã€‚"
        else
            echo "æ­£åœ¨å¯åŠ¨ Sing-box (å®ˆæŠ¤æ¨¡å¼)..."
            nohup sh "$SERVICE_PATH" > /dev/null 2>&1 &
            echo "å¯åŠ¨æŒ‡ä»¤å·²å‘é€ã€‚"
        fi
        ;;
    stop)
        echo "æ­£åœ¨åœæ­¢ Sing-box..."
        PID=$(pgrep -f "$BIN")
        if [ ! -z "$PID" ]; then
            PPID=$(ps -o ppid= -p "$PID" | tr -d ' ')
            if [ ! -z "$PPID" ]; then
                kill -15 "$PPID" >/dev/null 2>&1 || true
            fi
            kill -15 "$PID" >/dev/null 2>&1
            echo "ç­‰å¾…ä¸“ä¸šæ¸…ç† (VoLTE ä¿æŠ¤æœŸ)..."
            count=0
            while kill -0 "$PID" 2>/dev/null && [ $count -lt 10 ]; do
                sleep 1
                count=$((count + 1))
            done
            [ $count -ge 10 ] && kill -9 "$PID" || true
        fi
        pkill -15 -f "$SERVICE_PATH" >/dev/null 2>&1 || true
        echo "âœ… æœåŠ¡å·²åœæ­¢ (Native Cleanup)ã€‚"
        ;;
    restart)
        $0 stop
        sleep 1
        $0 start
        ;;
    update)
        echo "ğŸ“¡ æ­£åœ¨é€šè¿‡ EdgeOne è¿æ¥ miceworld æŒ‡æŒ¥éƒ¨ (One-Click Update)..."
        SBC_RS="$WORKSPACE/bin/sbc-rs"
        
        if [ ! -x "$SBC_RS" ]; then
             echo "âŒ ä¸¥é‡é”™è¯¯: æ‰¾ä¸åˆ°æ ¸å¿ƒç»„ä»¶ ($SBC_RS) æˆ–æ— æ‰§è¡Œæƒé™ã€‚"
             exit 1
        fi

        # 1. æ‰§è¡Œä¸‹è½½ä¸æ ¡éªŒ (Rust Native)
        "$SBC_RS" update \
            --template-url "$TEMPLATE_URL" \
            --template-path "$TEMPLATE" \
            --env-url "$ENV_EXAMPLE_URL" \
            --env-path "$ENV_EXAMPLE"
        
        RET=$?
        if [ $RET -ne 0 ]; then
             echo "âŒ æ›´æ–°å¤±è´¥ï¼Œæ ¸å¿ƒç»„ä»¶è¿”å›é”™è¯¯ç : $RET"
             exit $RET
        fi
        
        # 2. æ‰§è¡Œæ¸²æŸ“ä¸é‡è½½
        echo "æ­£åœ¨å”¤é†’æœ¬åœ°æ¸²æŸ“å¼•æ“ (Rust Engine)..."
        if [ -f "$ENV_FILE" ]; then
            set -a; . "$ENV_FILE"; set +a
            "$SBC_RS" render --template "$TEMPLATE" --output "$CONFFILE"
            RET=$?
            if [ $RET -eq 0 ]; then
                echo "ğŸš€ æ¸²æŸ“å®Œæˆ (Rust AST)ï¼Œæ‰§è¡Œçƒ­é‡è½½..."
                $0 restart
            else
                echo "âŒ æ¸²æŸ“å¤±è´¥ï¼Œé”™è¯¯ç : $RET"
            fi
        else
            echo "âš ï¸ è­¦å‘Šï¼šæœªå‘ç° .env å‡­è¯ï¼Œæ— æ³•å®Œæˆæ¸²æŸ“ã€‚"
        fi
        ;;
    status)
        if pgrep -f "$BIN" > /dev/null; then
            PID=$(pgrep -f "$BIN")
            echo "çŠ¶æ€: æ­£åœ¨è¿è¡Œ (PID: $PID)"
            echo "å·¥ä½œç©ºé—´: $WORKSPACE"
            echo "æ—¥å¿—æœ€å 5 è¡Œ:"
            tail -n 5 "$LOG_FILE"
        else
            echo "çŠ¶æ€: å·²åœæ­¢"
        fi
        ;;
    *)
        echo "ç”¨æ³•: sbc {start|stop|restart|status|update}"
        exit 1
        ;;
esac