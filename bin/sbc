#!/system/bin/sh
# Mice System Tools - Sing-box Controller (Professional Edition)

WORKSPACE="/data/adb/sing-box-workspace"
BIN="$WORKSPACE/bin/sing-box"
ENV_FILE="$WORKSPACE/.env"
TEMPLATE="$WORKSPACE/config.template.json"
CONFFILE="$WORKSPACE/etc/config.json"
SERVICE_PATH="/data/adb/modules/sing-box-ksu-module/service.sh"
LOG_FILE="$WORKSPACE/var/log/sing-box.log"
TEMPLATE_URL="https://miceworld.top/sing-box-config-templates/mobile/config.template.json"

case "$1" in
    start)
        if pgrep -f "$BIN" > /dev/null; then
            echo "Sing-box å·²ç»åœ¨è¿è¡Œä¸­ã€‚"
        else
            echo "æ­£åœ¨å¯åŠ¨ Sing-box (å®ˆæŠ¤æ¨¡å¼)..."
            nohup sh "$SERVICE_PATH" > /dev/null 2>&1 &
            echo "å¯åŠ¨æŒ‡ä»¤å·²å‘é€ã€‚"
        fi
        ;;
    stop)
        echo "æ­£åœ¨åœæ­¢ Sing-box..."
        PID=$(pgrep -f "$BIN")
        if [ ! -z "$PID" ]; then
            PPID=$(ps -o ppid= -p "$PID" | tr -d ' ')
            if [ ! -z "$PPID" ]; then
                kill -15 "$PPID" >/dev/null 2>&1 || true
            fi
            kill -15 "$PID" >/dev/null 2>&1
            echo "ç­‰å¾…ä¸“ä¸šæ¸…ç† (VoLTE ä¿æŠ¤æœŸ)..."
            count=0
            while kill -0 "$PID" 2>/dev/null && [ $count -lt 10 ]; do
                sleep 1
                count=$((count + 1))
            done
            [ $count -ge 10 ] && kill -9 "$PID" || true
        fi
        pkill -15 -f "$SERVICE_PATH" >/dev/null 2>&1 || true
        echo "âœ… æœåŠ¡å·²åœæ­¢ (Native Cleanup)ã€‚"
        ;;
    restart)
        $0 stop
        sleep 1
        $0 start
        ;;
    update)
        echo "ğŸ“¡ æ­£åœ¨é€šè¿‡ EdgeOne åŒæ­¥æŒ‡æŒ¥éƒ¨é…ç½®..."
        if curl -fL -o "$TEMPLATE.tmp" "$TEMPLATE_URL"; then
            if grep -q "inbounds" "$TEMPLATE.tmp"; then
                mv -f "$TEMPLATE.tmp" "$TEMPLATE"
                echo "âœ… é€»è¾‘åŒæ­¥æˆåŠŸã€‚æ­£åœ¨å”¤é†’æœ¬åœ°æ¸²æŸ“å¼•æ“..."
                if [ -f "$ENV_FILE" ]; then
                    set -a; . "$ENV_FILE"; set +a
                    "$WORKSPACE/bin/envsubst" < "$TEMPLATE" > "$CONFFILE"
                    echo "ğŸš€ æ¸²æŸ“å®Œæˆï¼Œæ‰§è¡Œé‡å¯..."
                    $0 restart
                else
                    echo "âš ï¸ æœªå‘ç° .env å‡­è¯ï¼Œè¯·å…ˆé…ç½®æœ¬åœ°å˜é‡ã€‚"
                fi
            else
                echo "âŒ æ ¡éªŒå¤±è´¥ï¼šå†…å®¹å¼‚å¸¸ã€‚"
                rm -f "$TEMPLATE.tmp"
            fi
        else
            echo "âŒ è¿æ¥ miceworld.top å¤±è´¥ã€‚"
        fi
        ;;
    status)
        if pgrep -f "$BIN" > /dev/null; then
            PID=$(pgrep -f "$BIN")
            echo "çŠ¶æ€: æ­£åœ¨è¿è¡Œ (PID: $PID)"
            echo "å·¥ä½œç©ºé—´: $WORKSPACE"
            echo "æ—¥å¿—æœ€å 5 è¡Œ:"
            tail -n 5 "$LOG_FILE"
        else
            echo "çŠ¶æ€: å·²åœæ­¢"
        fi
        ;;
    *)
        echo "ç”¨æ³•: sbc {start|stop|restart|status|update}"
        exit 1
        ;;
esac