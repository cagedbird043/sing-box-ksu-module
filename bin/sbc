#!/system/bin/sh
# Mice System Tools - Sing-box Controller (Professional Edition)

WORKSPACE="/data/adb/sing-box-workspace"
BIN="$WORKSPACE/bin/sing-box"
ENV_FILE="$WORKSPACE/.env"
TEMPLATE="$WORKSPACE/config.template.json"
CONFFILE="$WORKSPACE/etc/config.json"
SERVICE_PATH="/data/adb/modules/sing-box-ksu-module/service.sh"
LOG_FILE="$WORKSPACE/var/log/sing-box.log"
TEMPLATE_URL="https://miceworld.top/sing-box-config-templates/mobile/config.template.json"
ENV_EXAMPLE="$WORKSPACE/.env.example"
ENV_EXAMPLE_URL="https://miceworld.top/sing-box-config-templates/mobile/.env.example"
STOP_FLAG="$WORKSPACE/STOP"

SBC_RS="$WORKSPACE/bin/sbc-rs"
if [ ! -x "$SBC_RS" ]; then
    echo "âŒ ä¸¥é‡é”™è¯¯: æ‰¾ä¸åˆ°æ ¸å¿ƒç»„ä»¶ ($SBC_RS) æˆ–æ— æ‰§è¡Œæƒé™ã€‚"
    exit 1
fi

case "$1" in
    start)
        # æ¸…é™¤åœæ­¢æ ‡å¿—ï¼Œå…è®¸å®ˆæŠ¤è¿›ç¨‹è¿è¡Œ
        rm -f "$STOP_FLAG"
        if pgrep -f "$BIN" > /dev/null; then
            echo "Sing-box å·²ç»åœ¨è¿è¡Œä¸­ã€‚"
        else
            echo "æ­£åœ¨å¯åŠ¨ Sing-box (Rust ç›‘æŠ¤æ¨¡å¼)..."
            nohup "$SBC_RS" run \
                --config "$CONFFILE" \
                --template "$TEMPLATE" \
                -D "$WORKSPACE/var/lib/sing-box" \
                >> "$LOG_FILE" 2>&1 &
            echo "âœ… å¯åŠ¨æŒ‡ä»¤å·²å‘é€ (Background)ã€‚"
        fi
        ;;
    stop)
        echo "æ­£åœ¨åœæ­¢ Sing-box (Rust Stop)..."
        touch "$STOP_FLAG"
        "$SBC_RS" stop
        ;;
    restart)
        "$0" stop
        sleep 1
        "$0" start
        ;;
    update)
        # ç›´æ¥é€ä¼ ç»™ sbc-rs updateï¼Œé€»è¾‘éƒ½åœ¨ Rust é‡Œ
        echo "ğŸ“¡ æ­£åœ¨æ‰§è¡Œä¸€é”®æ›´æ–° (Rust Core)..."
        "$SBC_RS" update \
            --template-url "$TEMPLATE_URL" \
            --template-path "$TEMPLATE" \
            --env-url "$ENV_EXAMPLE_URL" \
            --env-path "$ENV_EXAMPLE" \
            && "$0" restart
        ;;
    status)
        if pgrep -f "$BIN" > /dev/null; then
            PID=$(pgrep -f "$BIN")
            echo "çŠ¶æ€: æ­£åœ¨è¿è¡Œ (PID: $PID)"
            echo "ç‰ˆæœ¬: $("$SBC_RS" --version)"
            echo "å·¥ä½œç©ºé—´: $WORKSPACE"
            echo "æ—¥å¿—æœ€å 5 è¡Œ:"
            tail -n 5 "$LOG_FILE"
        else
            echo "çŠ¶æ€: å·²åœæ­¢"
        fi
        ;;
    *)
        echo "ç”¨æ³•: sbc {start|stop|restart|status|update}"
        exit 1
        ;;
esac