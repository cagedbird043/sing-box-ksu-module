#!/system/bin/sh
# Mice System Tools - Sing-box Controller (Professional Edition)

WORKSPACE="/data/adb/sing-box-workspace"
BIN="$WORKSPACE/bin/sing-box"
# 这里改名为 PATH，更符合它作为绝对路径的身份
SERVICE_PATH="/data/adb/modules/sing-box-ksu-module/service.sh"
LOG_FILE="$WORKSPACE/var/log/sing-box.log"
TEMPLATE_URL="https://raw.githubusercontent.com/cagedbird043/sing-box-config-templates/mobile/config.template.json"

case "$1" in
    start)
        if pgrep -f "$BIN" > /dev/null; then
            echo "Sing-box 已经在运行中。"
        else
            echo "正在启动 Sing-box (守护模式)..."
            # 使用绝对路径，确保在任何目录下执行都能命中目标
            nohup sh "$SERVICE_PATH" > /dev/null 2>&1 &
            echo "启动指令已发送。"
        fi
        ;;
    stop)
        echo "正在执行暴力停机..."
        
        # 1. 找到二进制进程的 PID
        PID=$(pgrep -f "$BIN")
        
        if [ ! -z "$PID" ]; then
            # 2. 找到它的父进程 (PPid)
            # ps -o ppid= 会直接输出父进程号
            PPID=$(ps -o ppid= -p "$PID" | tr -d ' ')
            
            # 3. 优先杀掉父进程 (service.sh)，切断重试循环
            if [ ! -z "$PPID" ]; then
                kill -9 "$PPID" >/dev/null 2>&1 || true
            fi
            
            # 4. 补刀杀掉二进制进程
            kill -9 "$PID" >/dev/null 2>&1 || true
        fi

        # 2. 彻底清理：使用绝对路径作为特征码，杀掉所有残留的 service.sh 实例
        # 这样比刚才的 relative fragment 更安全，不会误杀其他 service.sh
        pkill -9 -f "$SERVICE_PATH" >/dev/null 2>&1 || true
        
        echo "✅ 所有相关进程已强制清除。"
        ;;
    restart)
        $0 stop
        sleep 1
        $0 start
        ;;
    update)
        echo "正在从云端同步配置模板..."
        # 使用临时文件下载，防止下载失败把本地模板搞丢了
        TEMP_TMPL="$WORKSPACE/config.template.json.tmp"
        if curl -fL -o "$TEMP_TMPL" "$TEMPLATE_URL"; then
            # 基础校验：如果是 404 或者空文件，grep 会失败
            if grep -q "{" "$TEMP_TMPL"; then
                mv -f "$TEMP_TMPL" "$WORKSPACE/config.template.json"
                chmod 644 "$WORKSPACE/config.template.json"
                echo "✅ 模板同步成功！执行重启以应用更改..."
                $0 restart
            else
                echo "❌ 错误：抓取到的文件内容异常。"
                rm -f "$TEMP_TMPL"
            fi
        else
            echo "❌ 错误：无法连接到 GitHub Raw，请检查网络。"
        fi
        ;;
    status)
        if pgrep -f "$BIN" > /dev/null; then
            PID=$(pgrep -f "$BIN")
            echo "状态: 正在运行 (PID: $PID)"
            echo "工作空间: $WORKSPACE"
            echo "日志最后 5 行:"
            tail -n 5 "$LOG_FILE"
        else
            echo "状态: 已停止"
        fi
        ;;
    *)
        echo "用法: sbc {start|stop|restart|status|update}"
        exit 1
        ;;
esac